name: Send 24h Reminders

on:
  schedule:
    # Run daily at 9 AM UTC (5 AM Martinique time)
    - cron: '0 9 * * *'
  workflow_dispatch: # Allow manual trigger
    inputs:
      test_mode:
        description: 'Test mode (dry run)'
        required: false
        default: 'false'
        type: boolean

jobs:
  send-reminders:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Trigger 24h Reminders
        run: |
          echo "üì° Calling Supabase Edge Function..."
          echo "Project Ref: ${{ secrets.SUPABASE_PROJECT_REF }}"
          echo "Anon Key: ${{ secrets.SUPABASE_ANON_KEY }}"

          # Use hardcoded project reference for now
          PROJECT_REF="nbjuhxzjgegjvigsstljy"
          URL="https://${PROJECT_REF}.supabase.co/functions/v1/send-reminders"
          
          echo "Calling URL: $URL"

          response=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.SUPABASE_ANON_KEY }}" \
            -H "Content-Type: application/json" \
            -H "apikey: ${{ secrets.SUPABASE_ANON_KEY }}" \
            "$URL")

          echo "Response: $response"

          success=$(echo $response | jq -r '.success // false')
          count=$(echo $response | jq -r '.count // 0')

          if [ "$success" = "true" ]; then
            echo "‚úÖ Successfully sent $count reminder notifications"
          else
            echo "‚ùå Failed to send reminders"
            echo "Error: $response"
            exit 1
          fi

      - name: Send Success Notification
        if: success()
        run: echo "üìß 24h reminders sent successfully!"

      - name: Send Failure Notification
        if: failure()
        run: echo "‚ùå Failed to send 24h reminders!"
